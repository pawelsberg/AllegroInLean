name: CI

on:
  push:
  pull_request:

# ── Centralized target lists (single source of truth) ──
# Adding a new demo or test? Edit here — every platform picks it up.
env:
  EXAMPLE_TARGETS: >-
    allegroLoopDemo allegroFullDemo allegroImageDemo allegroFontDemo
    allegroTtfDemo allegroPrimitivesDemo allegroAudioDemo allegroInputDemo
    allegroTransformDemo allegroJoystickDemo allegroEventDemo
    allegroGameLoopDemo allegroConfigDemo allegroColorDemo allegroUstrDemo
    allegroPathDemo allegroBlendingDemo allegroNativeDialogDemo
    allegroVideoDemo allegroSystemExtrasDemo allegroDisplayExtrasDemo
    allegroBitmapExtrasDemo allegroEventExtrasDemo
    allegroTransformExtrasDemo allegroPathExtrasDemo allegroUstrExtrasDemo
    allegroColorExtrasDemo allegroAudioExtrasDemo
    allegroPrimitivesExtrasDemo allegroConfigExtrasDemo
    allegroFontExtrasDemo allegroFileIODemo allegroShaderDemo
    allegroHapticDemo allegroJoystickExtrasDemo allegroMenuExtrasDemo
    allegroVideoFileDemo
  TEST_TARGETS: >-
    allegroSmoke allegroFuncTest allegroErrorTest
  # Console-only demos that can run headless in CI (no display / audio).
  HEADLESS_DEMOS: >-
    allegroConfigDemo allegroColorDemo allegroUstrDemo allegroPathDemo
    allegroSystemExtrasDemo allegroPathExtrasDemo allegroColorExtrasDemo
    allegroConfigExtrasDemo allegroFileIODemo allegroEventExtrasDemo

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest,  name: Linux   }
          - { os: macos-latest,   name: macOS   }
          - { os: windows-latest, name: Windows }
    defaults:
      run:
        shell: ${{ matrix.os == 'windows-latest' && 'msys2 {0}' || 'bash' }}

    steps:
      # ── Setup ──────────────────────────────────────────────────────
      - name: Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-allegro
            mingw-w64-x86_64-pkg-config
            make

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Lean (elan)
        uses: leanprover/lean-action@v1
        with:
          lake-package-directory: .

      - name: Cache Lake build
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ matrix.os }}-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            lake-${{ matrix.os }}-

      # ── Platform-specific Allegro install ──────────────────────────
      - name: Install Allegro (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            liballegro5-dev \
            liballegro-image5-dev \
            liballegro-ttf5-dev \
            liballegro-font5-dev \
            liballegro-primitives5-dev \
            liballegro-audio5-dev \
            liballegro-acodec5-dev \
            liballegro-dialog5-dev \
            liballegro-video5-dev \
            libgtk-3-dev

      - name: Install Allegro (macOS)
        if: runner.os == 'macOS'
        run: brew install allegro

      # ── Detect prefix ──────────────────────────────────────────────
      - name: Detect Allegro prefix
        id: allegro
        run: |
          set -euo pipefail
          if [ "$RUNNER_OS" = "Linux" ]; then
            PREFIX=/usr
          elif [ "$RUNNER_OS" = "macOS" ]; then
            PREFIX=$(brew --prefix)
          else
            PREFIX=$(pkg-config --variable=prefix allegro-5 2>/dev/null || echo "/mingw64")
          fi
          echo "prefix=$PREFIX" >> "$GITHUB_OUTPUT"
          echo "Allegro prefix: $PREFIX"

      # ── Build ──────────────────────────────────────────────────────
      - name: Build library
        run: |
          set -euo pipefail
          lake build -K allegroPrefix=${{ steps.allegro.outputs.prefix }}

      - name: Build examples
        run: |
          set -euo pipefail
          lake build -K allegroPrefix=${{ steps.allegro.outputs.prefix }} $EXAMPLE_TARGETS

      - name: Build tests
        run: |
          set -euo pipefail
          lake build -K allegroPrefix=${{ steps.allegro.outputs.prefix }} $TEST_TARGETS

      # ── Run tests ──────────────────────────────────────────────────
      - name: Run tests
        run: |
          set -euo pipefail
          .lake/build/bin/allegroSmoke
          .lake/build/bin/allegroFuncTest
          .lake/build/bin/allegroErrorTest

      # ── Run headless demos as extra smoke tests ────────────────────
      - name: Run headless demos
        run: |
          set -euo pipefail
          for demo in $HEADLESS_DEMOS; do
            echo "── $demo ──"
            .lake/build/bin/$demo
          done

      # ── Upload artifacts on failure ────────────────────────────────
      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.name }}
          path: .lake/build/
          retention-days: 5
