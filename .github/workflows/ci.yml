name: CI

on:
  push:
  pull_request:

# ── Centralized target lists (single source of truth) ──
# Adding a new demo or test? Edit here — every platform picks it up.
env:
  EXAMPLE_TARGETS: >-
    allegroLoopDemo allegroFullDemo allegroImageDemo allegroFontDemo
    allegroTtfDemo allegroPrimitivesDemo allegroAudioDemo allegroInputDemo
    allegroTransformDemo allegroJoystickDemo allegroEventDemo
    allegroGameLoopDemo allegroConfigDemo allegroColorDemo allegroUstrDemo
    allegroPathDemo allegroBlendingDemo allegroNativeDialogDemo
    allegroVideoDemo allegroSystemExtrasDemo allegroDisplayExtrasDemo
    allegroBitmapExtrasDemo allegroEventExtrasDemo
    allegroTransformExtrasDemo allegroPathExtrasDemo allegroUstrExtrasDemo
    allegroColorExtrasDemo allegroAudioExtrasDemo
    allegroPrimitivesExtrasDemo allegroConfigExtrasDemo
    allegroFontExtrasDemo allegroFileIODemo allegroShaderDemo
    allegroHapticDemo allegroJoystickExtrasDemo allegroMenuExtrasDemo
    allegroVideoFileDemo
  TEST_TARGETS: >-
    allegroSmoke allegroFuncTest allegroErrorTest
  # Console-only demos that can run headless in CI (no display / audio).
  HEADLESS_DEMOS: >-
    allegroConfigDemo allegroColorDemo allegroUstrDemo allegroPathDemo
    allegroSystemExtrasDemo allegroPathExtrasDemo allegroColorExtrasDemo
    allegroConfigExtrasDemo allegroFileIODemo allegroEventExtrasDemo

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest,  name: Linux   }
          - { os: macos-latest,   name: macOS   }
          - { os: windows-latest, name: Windows }
    defaults:
      run:
        shell: ${{ matrix.os == 'windows-latest' && 'msys2 {0}' || 'bash' }}

    steps:
      # ── Setup ──────────────────────────────────────────────────────
      - name: Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          path-type: inherit
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-pkg-config
            make

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Lean (elan)
        uses: leanprover/lean-action@v1
        with:
          lake-package-directory: .

      - name: Cache Lake build
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ matrix.os }}-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            lake-${{ matrix.os }}-

      # ── Build Allegro 5.2.11 from source ───────────────────────────
      - name: Install Allegro build deps (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y cmake build-essential pkg-config \
            libgl-dev libasound2-dev libpulse-dev \
            libx11-dev libxcursor-dev libxrandr-dev libxi-dev libxinerama-dev \
            libgtk-3-dev libglib2.0-dev libwebp-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

      - name: Cache Allegro build
        uses: actions/cache@v4
        with:
          path: allegro-local
          key: allegro-5.2.11-v2-${{ runner.os }}

      - name: Build Allegro from source
        run: |
          if [ ! -f allegro-local/lib/pkgconfig/allegro-5.pc ] && \
             [ ! -f allegro-local/lib64/pkgconfig/allegro-5.pc ]; then
            ./scripts/build-allegro.sh
            rm -rf allegro-src   # save disk space
          else
            echo "Using cached Allegro build"
          fi

      # ── Build ──────────────────────────────────────────────────────
      - name: Build library
        run: lake build

      - name: Build examples
        run: lake build $EXAMPLE_TARGETS

      - name: Build tests
        run: lake build $TEST_TARGETS

      # ── Run tests ──────────────────────────────────────────────────
      - name: Run tests
        run: |
          set -euo pipefail
          .lake/build/bin/allegroSmoke
          .lake/build/bin/allegroFuncTest
          .lake/build/bin/allegroErrorTest

      # ── Run headless demos as extra smoke tests ────────────────────
      - name: Run headless demos
        run: |
          set -euo pipefail
          for demo in $HEADLESS_DEMOS; do
            echo "── $demo ──"
            .lake/build/bin/$demo
          done

      # ── Upload artifacts on failure ────────────────────────────────
      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.name }}
          path: .lake/build/
          retention-days: 5
